<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>User Blog</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/toastr.js/latest/css/toastr.min.css">
    <style>
        /* .message-list {
          border: 1px solid #ccc;
          padding: 10px;
        } */
      
        .message-item {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 10px;
        }
      
        .delete-button {
          background-color: rgb(231, 169, 169);
          color: white;
          border: none;
          padding: 5px 10px;
          cursor: pointer;
        }
        .delete-button:hover {
            background-color: rgb(235, 102, 102);
        }
    </style>
    <style>
        /*导航*/
        body {
            margin: 0;
            padding: 0;
        }

        .navbar {
            background-color: #333;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .navbar-brand {
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
        }

        .navbar-menu {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .navbar-menu li {
            margin-left: 20px;
        }

        .navbar-menu li a {
            color: #fff;
            text-decoration: none;
            font-size: 16px;
            font-weight: bold;
        }

        .navbar-menu li a:hover {
            color: #ff0;
        }
    </style>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #7b7979fa;
            padding: 0px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #b6b3b3;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .user-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .user-info img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .user-info h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .user-info p {
            font-size: 16px;
            color: #666666;
        }

        .message-list {
            margin-top: 30px;
        }

        .message-item {
            margin-bottom: 20px;
            border-bottom: 1px solid #cccccc;
            padding-bottom: 10px;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-item h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .message-item p {
            font-size: 16px;
            color: #666666;
        }

        .toast-center-center {
           top: 50%;
           left: 50%;
           margin-top: -30px;
           margin-left: -150px;
        }

        .close-button {
          position: absolute;
          top: 10px;
          right: 10px;
          cursor: pointer;
        }

        .profile-section {
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-bottom: 20px; /* 调整头像和输入框之间的间距 */
        }

        .profile-picture {
          width: 100px; /* 调整头像容器的宽度 */
          height: 100px; /* 调整头像容器的高度 */
          border-radius: 50%; /* 将头像容器变为圆形 */
          overflow: hidden; /* 隐藏头像溢出的部分 */
        }

        #edit-profile-pic {
          width: 100%; /* 让头像填充整个容器 */
          height: 100%; /* 让头像填充整个容器 */
          object-fit: cover; /* 调整头像的缩放和裁剪方式 */
        }

        .profile-input {
          margin-top: 10px; /* 调整输入框和头像之间的间距 */
        }

        .button-container {
          display: flex;
          justify-content: center;
        }

        /*消息发布相关开始*/
        .message-input {
            display: flex;
            margin-top: 20px;
        }
        .message-input input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        .message-input button {
            padding: 10px 20px;
            margin-left: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .message-input button:hover {
            background-color: #45a049;
        }
        /*消息发布相关结束*/

        /*分页*/
        .pagination {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .pagination a {
            margin: 0 5px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            text-decoration: none;
            color: #333;
        }

        .pagination a.active {
            background-color: #ccc;
        }
            /*分页*/
    </style>
    <style>
        /* 消息脚 */
        .message-footer {
            display: flex;
            justify-content: flex-end;
        }
        /* 消息删除按钮所在div */
        .message-btn-elem {
            display: flex;
            justify-content: flex-end;
        }
        /*作者和发布时间的字体*/
        .message-author,
        .message-time{
        font-family: "Brush Script MT", cursive;
        color: rgb(50, 60, 46);
        }
        .message-content,
        .message-title {
        font-family: "Brush Script MT", cursive;
        color: rgb(8, 8, 8);
        }
    </style>
    <style>
        /* 评论区 */
        .comment-container {
        margin-top: 5px;
        }

        .comment-form {
        display: flex;
        align-items: center;
        }

        .comment-input {
        flex-grow: 1;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 2px;
        font-size: 12px;
        font-family: "Brush Script MT", cursive;
        transition: border-color 0.3s ease;
        }

        .comment-input:focus {
        outline: none;
        border-color: #007bff;
        }

        .comment-submit {
        margin-left: 6px;
        padding: 6px 12px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 2px;
        font-size: 12px;
        font-family: "Brush Script MT", cursive;
        cursor: pointer;
        transition: background-color 0.3s ease;
        }

        .comment-submit:hover {
        background-color: #0056b3;
        }

        .comment {
        margin-top: 5px;
        padding: 8px;
        background-color: #f5f5f5;
        border: 1px solid #ccc;
        border-radius: 2px;
        font-size: 10px;
        font-family: "Brush Script MT", cursive;
        line-height: 1.2;
        }
    </style>
    <style>
        /* 评论区 */
        .ccomment {
        display: block;
        width: 100%;
        }
        .cnick {
        font-size: 10px;
        font-family: "Brush Script MT", cursive;
        color:#b4b7ba
        }
        .open_comment{
        font-size: 10px;
        font-family: "Brush Script MT", cursive;
        }
        .rnick{
        color:#b4b7ba;
        display: block;
        width: 100%;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="#" class="navbar-brand">Logo</a>
        <ul class="navbar-menu">
            <li><a href="./userInfo.html">主页空间</a></li>
            <li><a href="./updateInfo.html">个人资料</a></li>
            <li><a href="#">Services</a></li>
            <li><a href="#">Contact</a></li>
            <li><a href="#" id="logout-btn">退出登录</a></li>
        </ul>
    </div>
    
    <div class="container">
        <div class="user-info">
            <img id="user-pic" src="" alt="User Picture">
            <h2 id="user-nick"></h2>
            <p id="user-id"></p>
        </div>
    
        <div class="message-list">
            <div class="message">
                <div class="message-header">
                    <h3 class="message-title"></h3>
                </div>
                <div class="message-content">
                </div>
                <div class="message-footer">
                    <p class="message-author"></p>
                    <p class="message-time"></p>
                </div>
            </div>
        </div>
    
        <div class="pagination" id="pagination"></div>
        <div class="message-input">
            <input type="text" id="message-text" placeholder="输入...">
            <button id="send-btn">发布</button>
        </div>
    </div>


<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/toastr.js/latest/js/toastr.min.js"></script>
<script src="logout.js"></script>
<script>
     function refreshPage() {
      location.reload();
     }

    toastr.options = {
      closeButton: true,
      progressBar: true,
      positionClass: "toast-center-center", // 居中显示
      timeOut: 3000 // 3秒后自动关闭
    };
    // Create a new XMLHttpRequest object
    var xhr1 = new XMLHttpRequest();
    // Define the request URL and method
    var url = 'http://101.42.251.239:8080/getUserInfo';
    var method = 'GET';
    // Set up the request
    xhr1.open(method, url, true);
    xhr1.setRequestHeader('Content-Type', 'application/json');
    // Create the request body
    var requestBody = JSON.stringify({});
    // Send the request
    xhr1.send(requestBody);
    // Set up the callback function to handle the response
    xhr1.onload = function () {
        if (xhr1.status === 200) {
            var response = JSON.parse(xhr1.responseText);
            if (response.ret != 0 ) {
                if (response.ret == 4) {
                    window.location.href = "http://101.42.251.239:8080"
                    return
                }
            }
            // Update the user info on the page
            document.getElementById('user-pic').src = response.pic;
            document.getElementById('user-nick').textContent = response.nick;
            document.getElementById('user-id').textContent = 'UserID: ' + response.uid;
        }else {
            window.location.href = "http://101.42.251.239:8080"
        }
    };
    

    function getMsgListFunc(page, callback) {
        // Create a new XMLHttpRequest object
        var xhr = new XMLHttpRequest();
        // Define the request URL and method
        var url = 'http://101.42.251.239:8080/getMessageList';
        var method = 'POST';
        // Set up the request
        xhr.open(method, url, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
         // 构建请求参数对象
        var params = {
            page: page,
            page_size: 10
        };

        // Create the request body
        var requestBody = JSON.stringify(params);
        // Send the request
        xhr.send(requestBody);
        // Set up the callback function to handle the response
        xhr.onload = function () {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                // Update the user info on the page
                //Render the message list
                var messageList = response.list;
                callback(response)
                return
            }
        };
    }

    var sendBtn = document.getElementById('send-btn');
    sendBtn.addEventListener('click', function () {
        var xhr = new XMLHttpRequest();
        // 设置属性
        xhr.open('post', 'http://101.42.251.239:8080/publishMessage');
        // 如果想要使用post提交数据,必须添加此行
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        // 将数据通过send方法传递
        var msg = document.getElementById("message-text").value;

        // 构建请求参数对象
        var params = {
            message: msg,
        };
        xhr.send(JSON.stringify(params));
        // 发送并接受返回值
        xhr.onreadystatechange = function () {
            // 这步为判断服务器是否正确响应
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var obj = JSON.parse(xhr.responseText);
                    if (obj.ret === 4) {
                        window.location.href = obj.url;
                        return
                    }else if (obj.ret === 0) {
                        //refreshPage()
                        toastr.success("发布成功!");
                        refreshMessageList(1)
                        // 清空输入框
                        document.getElementById("message-text").value = "";
                    }else {
                        toastr.error(obj.ret);
                    }
                }else {
                    toastr.error("err!!!");
                }
            }
        };
    });

    function refreshMessageList(curPage) {
        // 移除所有子元素
        var messageList = document.querySelector(".message-list");
        messageList.innerHTML = "";
        getMsgListFunc(curPage, function(response) {
            // 在回调函数中处理返回值
            var rsp = response;
            //var messageList = document.getElementById("message-list");
            var messageList = document.querySelector(".message-list");
            messageList.innerHTML = "";
            showMsgList2(rsp.list)
            renderPagination(rsp.count);
        });
    }

    function closeEditProfileModal() {
        var editProfileModal = document.getElementById('edit-profile-modal');
        editProfileModal.style.display = 'none';
    }

    function closeModal() {
      var editProfileModal = document.getElementById('edit-profile-modal');
      editProfileModal.style.display = 'none';
    }

    var messages = []; // 存储所有的消息
    var pageSize = 10; // 每页显示的消息数量
    var currentPage = 1; // 当前页码


    // 渲染当前页的消息列表
    function renderMessages() {
        if (currentPage < 1) {
            return
        }
        getMsgListFunc(currentPage, function(response) {
            // 在回调函数中处理返回值
            var rsp = response;
            //var messageList = document.getElementById("message-list");
            var messageList = document.querySelector(".message-list");
            // 移除所有子元素
            messageList.innerHTML = "";
            showMsgList2(rsp.list)
            renderPagination(rsp.count);
        });

    }
    //初始化先渲染一次
    renderMessages()

    //渲染展示当前页信息列表
    function showMsgList2(messages) {
        var messageList = document.querySelector('.message-list');
        messages.forEach(function(message) {
            // 创建消息元素
            var messageElement = document.createElement('div');
            messageElement.classList.add('message');

            // 创建消息头部元素
            var headerElement = document.createElement('div');
            headerElement.classList.add('message-header');

            // 创建消息标题元素
            var titleElement = document.createElement('h4');
            titleElement.classList.add('message-title');
            //titleElement.textContent = message.title;
            titleElement.textContent = "消息-"+message.id;

            // 将标题和时间元素添加到消息头部元素中
            headerElement.appendChild(titleElement);

            // 创建消息内容元素
            var contentElement = document.createElement('div');
            contentElement.classList.add('message-content');
            contentElement.textContent = message.msg;

            // 创建消息底部元素
            var footerElement = document.createElement('div');
            footerElement.classList.add('message-footer');

            // 创建消息作者元素
            var authorElement = document.createElement('p');
            authorElement.classList.add('message-author');
            authorElement.textContent = "发布人: "+message.owner;


            // 创建消息底部元素
            var btnElement = document.createElement('div');
            btnElement.classList.add('message-btn-elem');
            // 创建删除按钮元素
            var deleteButton = document.createElement("button");
                deleteButton.className = "delete-button";
                deleteButton.textContent = "Delete";
                // 创建闭包来捕获 messageList[i] 的值
                (function(id) {
                    deleteButton.addEventListener("click", function() {
                        deleteMsg(id);
                        //messageItem.remove();
                    });
                })(message.id);
            btnElement.appendChild(deleteButton)


            // 创建消息时间元素
            var timeElement = document.createElement('p');
            timeElement.classList.add('message-time');
            timeElement.textContent = "|发布时间: "+message.c_time;

            // 将作者元素添加到消息底部元素中
            footerElement.appendChild(authorElement);
            footerElement.appendChild(timeElement);

            // 将头部、内容和底部元素添加到消息元素中
            messageElement.appendChild(headerElement);
            messageElement.appendChild(contentElement);
            messageElement.appendChild(footerElement);
            messageElement.appendChild(btnElement)

            // 将消息元素添加到消息列表容器中
            messageList.appendChild(messageElement);


            //评论区
            // 创建评论区容器
            var commentContainer = document.createElement('div');
            commentContainer.classList.add('comment-container');

            // 创建评论表单
            var commentForm = document.createElement('form');
            commentForm.addEventListener('submit', function(event) {
                event.preventDefault(); // 阻止表单默认提交行为

                // 获取评论内容
                var commentInput = commentForm.querySelector('.comment-input');
                var commentText = commentInput.value;

                // 创建新的评论元素
                var commentElement = document.createElement('div');
                commentElement.classList.add('comment');
                commentElement.textContent = commentText;

                // 将新的评论元素添加到评论区容器中
                commentContainer.appendChild(commentElement);

                setCommentFunc(commentText)

                // 清空评论输入框
                commentInput.value = '';
            });

            // 创建评论输入框
            var commentInput = document.createElement('input');
            commentInput.classList.add('comment-input');
            commentInput.setAttribute('type', 'text');
            commentInput.setAttribute('placeholder', '输入评论...');
            commentForm.appendChild(commentInput);

            // 创建提交按钮
            var submitButton = document.createElement('button');
            submitButton.setAttribute('type', 'submit');
            submitButton.classList.add('comment-submit');
            submitButton.textContent = '评论';
            commentForm.appendChild(submitButton);


            var commentListContainer = document.createElement('div');
            var openCommentBtn = document.createElement('span');
            openCommentBtn.classList.add('open_comment');
            openCommentBtn.textContent = "展开评论";
            commentListContainer.style.display = 'none';
            openCommentBtn.addEventListener('click', function() {
                // 切换回复列表容器的显示状态
                if (commentListContainer.style.display === 'none') {
                    commentListContainer.style.display = 'block';
                    openCommentBtn.textContent = '收起评论';
                } else {
                    commentListContainer.style.display = 'none';
                    openCommentBtn.textContent = '展开评论';
                }
            });

            // 将评论表单添加到评论区容器中
            commentContainer.appendChild(commentForm);
            commentContainer.appendChild(openCommentBtn)

            if (message.comment_list != null) {
                //渲染当前有的评论
                message.comment_list.forEach(function(comment) {

                    //评论昵称+时间
                    var cnick = document.createElement('span');
                    cnick.classList.add('cnick');
                    cnick.textContent = comment.user_name+comment.c_time+"  ";

                    //评论内容
                    var ccomment= document.createElement('span');
                    ccomment.classList.add('ccomment');
                    ccomment.textContent = comment.comment;

                    // 创建新的评论元素
                    var commentElement1 = document.createElement('div');
                    commentElement1.classList.add('comment');
                    //commentElement1.textContent = comment.comment;

                    commentElement1.appendChild(ccomment)
                    commentElement1.appendChild(cnick)
                    //回复start
                    // 创建回复列表容器
                    var replyListContainer = document.createElement('div');
                    replyListContainer.classList.add('reply-list-container');
                    replyListContainer.style.display = 'none'; // 初始隐藏回复列表

                    // 创建展开/收回文本
                    var toggleLink = document.createElement('span');
                    toggleLink.classList.add('toggle-link');
                    toggleLink.textContent = '展开回复';
                    toggleLink.addEventListener('click', function() {
                        // 切换回复列表容器的显示状态
                        if (replyListContainer.style.display === 'none') {
                            replyListContainer.style.display = 'block';
                            toggleLink.textContent = '收起回复';
                        } else {
                            replyListContainer.style.display = 'none';
                            toggleLink.textContent = '展开回复';
                        }
                    });

                    // 将展开/收回文本添加到评论元素中
                    commentElement1.appendChild(toggleLink);

                    // 将回复列表容器添加到评论元素中
                    commentElement1.appendChild(replyListContainer);

                    if (comment.reply_list !=null) {
                        // 遍历每个回复数据
                        comment.reply_list.forEach(function(replyData) {

                            //回复昵称+时间
                            var rnick = document.createElement('span');
                            rnick.classList.add('rnick');
                            rnick.textContent = replyData.user_name+"->"+replyData.to_user_name+"  "+replyData.c_time
                            // 创建回复元素
                            var replyElement = document.createElement('div');
                            replyElement.classList.add('reply');
                            replyElement.textContent = replyData.reply;

                            // 创建回复链接
                            var replyLink = document.createElement('span');
                            replyLink.classList.add('toggle-link');
                            replyLink.textContent = '回复';
                            replyLink.addEventListener('click', function() {
                                // 在回复输入框中显示回复目标的信息
                                var replyInput = commentElement1.querySelector('.comment-input');
                                replyInput.value = '回复 ' + replyData.to_user_name + ': ';

                                // 将焦点设置到回复输入框
                                replyInput.focus();
                            });

                            // 将回复元素和回复链接添加到回复列表容器中
                            replyListContainer.appendChild(rnick);
                            replyListContainer.appendChild(replyElement);
                            replyListContainer.appendChild(replyLink);
                        });
                    }
                    //回复end



                    // 将新的评论元素添加到评论区容器中
                    commentListContainer.appendChild(commentElement1);
                });
            }

            commentContainer.appendChild(commentListContainer)

            // 将评论区容器添加到消息元素中
            messageElement.appendChild(commentContainer);

            // 将消息元素添加到消息列表容器中
            messageList.appendChild(messageElement);
        });
    }


    //删除信息
    function deleteMsg(msg_id) {
         // Create a new XMLHttpRequest object
         var xhr = new XMLHttpRequest();
         // Define the request URL and method
         var url = 'http://101.42.251.239:8080/deleteMessage';
         var method = 'POST';
         // Set up the request
         xhr.open(method, url, true);
         xhr.setRequestHeader('Content-Type', 'application/json');
         // 构建请求参数对象
         var params = {
             message_id: msg_id,
         };

         // Create the request body
         var requestBody = JSON.stringify(params);
         // Send the request
         xhr.send(requestBody);
         // Set up the callback function to handle the response
         xhr.onload = function () {
             if (xhr.status === 200) {
                 var response = JSON.parse(xhr.responseText);
                 if (response.ret === 0) {
                     toastr.success("删除成功!");
                     refreshMessageList(currentPage)
                 }else {
                     toastr.error("删除失败!")
                 }
                 return
             }
         };
     }

    // 渲染分页导航
    function renderPagination(msgCount) {
        var totalPages = Math.ceil(msgCount / pageSize);
        var pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        for (var i = 1; i <= totalPages; i++) {
            var pageLink = document.createElement("a");
            pageLink.href = "#";
            pageLink.textContent = i;

            if (i === currentPage) {
                pageLink.classList.add("active");
            }

            pageLink.addEventListener("click", function() {
                currentPage = parseInt(this.textContent);
                renderMessages();
            });
            pagination.appendChild(pageLink);
        }
    }

    //发布评论
     function setCommentFunc(comment) {
         // Create a new XMLHttpRequest object
         var xhr = new XMLHttpRequest();
         // Define the request URL and method
         var url = 'http://101.42.251.239:8080/addComment';
         var method = 'POST';
         // Set up the request
         xhr.open(method, url, true);
         xhr.setRequestHeader('Content-Type', 'application/json');
         // 构建请求参数对象
         var params = {
             comment_info:comment,
         };

         // Create the request body
         var requestBody = JSON.stringify(params);
         // Send the request
         xhr.send(requestBody);
         // Set up the callback function to handle the response
         xhr.onload = function () {
             if (xhr.status === 200) {
                 var response = JSON.parse(xhr.responseText);
                 toastr.success("发布评论成功!");
                 return
             }else {
                 toastr.error("发布评论失败!");
             }
         };
     }

    // 上一页按钮点击事件处理
    // document.getElementById("prev-page-btn").addEventListener("click", function() {
    //     if (currentPage > 1) {
    //         currentPage--;
    //         renderMessages();
    //     }
    // });

    // // 下一页按钮点击事件处理
    // document.getElementById("next-page-btn").addEventListener("click", function() {
    //     var totalPages = Math.ceil(messages.length / pageSize);
    //     if (currentPage < totalPages) {
    //         currentPage++;
    //         renderMessages();
    //     }
    // });

    // 监听发布按钮的点击事件
    document.getElementById("send-btn").addEventListener("click", function() {
        // var messageText = document.getElementById("message-text").value;
        // addMessage(messageText);
        document.getElementById("message-text").value = "";
    });

    // 添加点击事件监听器
    document.getElementById("logout-btn").addEventListener("click", myFunction);
    // 定义 myFunction 函数
    function myFunction() {
    logout()
    }

</script>

</body>
</html>
